doctype html
html
    head
        title Cargar Médico
        link(href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap", rel="stylesheet")
        link(rel="stylesheet", href="/css/headerAdmin.css")
        link(rel="stylesheet" href="/css/adminCreateProfesional.css")
        link(rel="stylesheet" href="/css/alerta.css")
        link(rel="stylesheet" href="/css/footerNuevo.css")
    body
        include ../includes/headerAdmin
        if msg == 'ok'
            div.alert.alert-success
                span.icon ✓
                |  Médico cargado exitosamente

        if msg == 'error'
            div.alert.alert-error
                span.icon ⚠
                |  Hubo un error al cargar el médico. Inténtalo de nuevo.
        main(class="mainAdminCreateProfesional")
            form(action="/profesional/crear", method="POST" class="formCreate")
                span(class="spanCreate") Cargar un médico
                p(class="infoCreate") Si el médico ya existe, se le agregará la especialidad seleccionada sin importar los demás datos.
                fieldset(class="dni") 
                    label(for="dni" class="lbDNI") DNI: 
                    input(type="number", id="dni", name="dni", required, placeholder="DNI" class="inputDNI")
                fieldset(class="nombre") 
                    label(for="nombre" class="lbNombre") Nombre: 
                    input(type="text", id="nombre", name="nombre", required, placeholder="Nombre" class="inputNombre")
                fieldset(class="apellido") 
                    label(for="apellido" class="lbApellido") Apellido: 
                    input(type="text", id="apellido", name="apellido", required, placeholder="Apellido" class="inputApellido")
                fieldset(class="fecha_nacimiento") 
                    label(for="fecha_nacimiento" class="lbFechaNacimiento") Fecha de Nacimiento: 
                    input(type="date", id="fecha_nacimiento", name="fecha_nacimiento", required class="inputFechaNacimiento")
                fieldset(class="telefono") 
                    label(for="telefono" class="lbTelefono") Teléfono: 
                    input(type="number", id="telefono", name="telefono", required, placeholder="Teléfono" class="inputTelefono")
                fieldset(class="email") 
                    label(for="email" class="lbEmail") Email: 
                    input(type="email", id="email", name="email", required, placeholder="Email" class="inputEmail")
                fieldset(class="domicilio_personal") 
                    label(for="domicilio_personal" class="lbDomicilioPersonal") Domicilio Personal: 
                    input(type="text", id="domicilio_personal", name="domicilio_personal", required, placeholder="Domicilio Personal" class="inputDomicilioPersonal")
                fieldset(class="matricula")
                    label(for="matricula" class="lbMatricula") Matricula: 
                    input(type="text", id="matricula", name="matricula", required, placeholder="Matrícula" class="inputMatricula")
                fieldset(class="especialidad")
                    label(for="especialidad" class="lbEspecialidad") Especialidad: 
                    select(name="especialidad" class="selectEspecialidad")
                        option(value="cardiologia") Cardiología
                        option(value="pediatria") Pediatria
                        option(value="kinesiologia") Kinesiología
                        option(value="psicologia") Psicología
                        option(value="odontologia") Odontología
                button(type="submit" class="botonCreate") Cargar médico
        include ../includes/footer
        script(src="/js/logout.js")
        script(src="/js/alerta.js")
        script.
            const form = document.querySelector('.formCreate');

            form.addEventListener('submit', function (e) {
                //limpiamos espacios
                nombreInput.value = nombreInput.value.trim();
                apellidoInput.value = apellidoInput.value.trim();

                //dni
                if (!/^\d{8,}$/.test(dniInput.value)) {
                    alert('El DNI debe tener solo números y mínimo 8 dígitos');
                    dniInput.focus();
                    e.preventDefault();
                    return;
                }

                //nombre
                if (!/^[A-Za-zÁÉÍÓÚáéíóúÑñ]+$/.test(nombreInput.value)) {
                    alert('El nombre solo puede tener letras y sin espacios');
                    nombreInput.focus();
                    e.preventDefault();
                    return;
                }

                //apellido
                if (!/^[A-Za-zÁÉÍÓÚáéíóúÑñ]+$/.test(apellidoInput.value)) {
                    alert('El apellido solo puede tener letras y sin espacios');
                    apellidoInput.focus();
                    e.preventDefault();
                    return;
                }

                //telefono
                if (!/^\d{10,}$/.test(telefonoInput.value)) {
                    alert('El teléfono debe tener solo números y mínimo 10 dígitos');
                    telefonoInput.focus();
                    e.preventDefault();
                    return;
                }

                //fecha de nacimiento
                const hoy = new Date();
                hoy.setHours(0,0,0,0);

                const fechaNac = new Date(fechaNacimientoInput.value);

                if (fechaNac > hoy) {
                    alert('La fecha de nacimiento no puede ser futura');
                    fechaNacimientoInput.focus();
                    e.preventDefault();
                    return;
                }
            });

            //validaciones en vivo
            dniInput.addEventListener('input', () => {
                dniInput.value = dniInput.value.replace(/\D/g, '');
            });

            telefonoInput.addEventListener('input', () => {
                telefonoInput.value = telefonoInput.value.replace(/\D/g, '');
            });

            nombreInput.addEventListener('input', () => {
                nombreInput.value = nombreInput.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ]/g, '');
            });

            apellidoInput.addEventListener('input', () => {
                apellidoInput.value = apellidoInput.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ]/g, '');
            });
        script.
            //autocompletamos datos del profesional cuando se ingresa un DNI existente
            const dniInput = document.getElementById('dni');
            const nombreInput = document.getElementById('nombre');
            const apellidoInput = document.getElementById('apellido');
            const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
            const telefonoInput = document.getElementById('telefono');
            const emailInput = document.getElementById('email');
            const domicilioInput = document.getElementById('domicilio_personal');
            
            let timeoutId = null;
            
            dniInput.addEventListener('input', function() {
                const dni = this.value.trim();
                
                //limpiamos timeout anterior
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                
                //si el dni tiene al menos 7 caracteres, buscamos
                if (dni.length >= 7) {
                    timeoutId = setTimeout(async () => {
                        try {
                            const response = await fetch(`/profesional/buscar-por-dni/${dni}`);
                            const data = await response.json();
                            
                            if (data.found && data.data) {
                                const profesional = data.data;
                                
                                //autocompletamos campos
                                nombreInput.value = profesional.nombre || '';
                                apellidoInput.value = profesional.apellido || '';
                                
                                //formateamos fecha si existe
                                if (profesional.fecha_nacimiento) {
                                    const fecha = new Date(profesional.fecha_nacimiento);
                                    const year = fecha.getFullYear();
                                    const month = String(fecha.getMonth() + 1).padStart(2, '0');
                                    const day = String(fecha.getDate()).padStart(2, '0');
                                    fechaNacimientoInput.value = `${year}-${month}-${day}`;
                                }
                                
                                telefonoInput.value = profesional.telefono || '';
                                emailInput.value = profesional.email || '';
                                domicilioInput.value = profesional.domicilio_personal || '';
                                
                                //deshabilitamos campos para evitar edicion accidental
                                nombreInput.disabled = true;
                                apellidoInput.disabled = true;
                                fechaNacimientoInput.disabled = true;
                                telefonoInput.disabled = true;
                                emailInput.disabled = true;
                                domicilioInput.disabled = true;
                                
                                //mostramos mensaje informativo
                                nombreInput.style.backgroundColor = '#e8f5e9';
                                apellidoInput.style.backgroundColor = '#e8f5e9';
                                fechaNacimientoInput.style.backgroundColor = '#e8f5e9';
                                telefonoInput.style.backgroundColor = '#e8f5e9';
                                emailInput.style.backgroundColor = '#e8f5e9';
                                domicilioInput.style.backgroundColor = '#e8f5e9';
                            } else {
                                //si no se encuentra, habilitamos campos
                                habilitarCampos();
                            }
                        } catch (error) {
                            console.error('Error al buscar profesional:', error);
                            habilitarCampos();
                        }
                    }, 500); //esperamos 500ms despues de que el usuario deje de escribir
                } else {
                    //si el dni es muy corto, limpiamos y habilitamos campos
                    limpiarYHabilitarCampos();
                }
            });
            
            function habilitarCampos() {
                nombreInput.disabled = false;
                apellidoInput.disabled = false;
                fechaNacimientoInput.disabled = false;
                telefonoInput.disabled = false;
                emailInput.disabled = false;
                domicilioInput.disabled = false;
                
                nombreInput.style.backgroundColor = '';
                apellidoInput.style.backgroundColor = '';
                fechaNacimientoInput.style.backgroundColor = '';
                telefonoInput.style.backgroundColor = '';
                emailInput.style.backgroundColor = '';
                domicilioInput.style.backgroundColor = '';
            }
            
            function limpiarYHabilitarCampos() {
                nombreInput.value = '';
                apellidoInput.value = '';
                fechaNacimientoInput.value = '';
                telefonoInput.value = '';
                emailInput.value = '';
                domicilioInput.value = '';
                habilitarCampos();
            }