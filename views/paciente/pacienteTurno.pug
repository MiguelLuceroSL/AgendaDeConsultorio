doctype html
html
  head
    title Vista Paciente
    link(href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap", rel="stylesheet")
    link(rel="stylesheet" href="/css/pacienteTurno.css")
    link(rel="stylesheet" href="/css/alerta.css")
    link(rel="stylesheet" href="/css/headerPaciente.css")
    link(rel="stylesheet" href="/css/footerNuevo.css")
    link(rel="stylesheet" href="/css/autocompletar_estilos.css")
    link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css")
  body
    include ../includes/headerPaciente
    if msg == 'ok'
      div.alert.alert-success
        span.icon ✓
        |  Turno reservado exitosamente

    if msg == 'error'
      div.alert.alert-error
        span.icon ⚠
        |  Hubo un error al reservar el turno
    main(class="mainPacienteTurno")
      h1 ¡Reserva tu turno ahora!
      form(action="/turnos/crearPaciente" method="POST" class="formTurnos" enctype="multipart/form-data")
        h3 Seleccioná Sucursal y Especialidad
        .filtros-container
          div.divFiltro
            label(for="sucursal-filtro") Sucursal: *
            select(id="sucursal-filtro" class="filtro-select" required)
              option(value="" selected disabled) Selecciona una sucursal
          div.divFiltro
            label(for="especialidad-filtro") Especialidad: *
            select(id="especialidad-filtro" class="filtro-select" required)
              option(value="" selected disabled) Selecciona una especialidad
        h3 Seleccioná un Profesional
        div.divFiltro
          label(for="profesional-select") Profesional: *
          select(id="profesional-select" name="profesional_especialidad_id" class="filtro-select" required disabled)
            option(value="" selected disabled) Primero seleccioná sucursal y especialidad
        input(type="hidden" name="paciente_id" value=idPaciente)
        input(type="hidden" name="sucursal_id" id="sucursal-id-hidden")
        label(for="fecha") Selecciona la fecha:
        input(type="text" name="fecha" id="fecha" required)
        label(for="horario") Selecciona un horario:
        select(name="hora" id="horario" required)
          option(value="" selected disabled) Selecciona un horario
        label(for="detalle_turno") Detalle del turno (opcional):
        textarea(name="detalle_turno" id="detalle_turno" rows="4" placeholder="Detalles adicionales del turno")
        input(type="hidden" name="estado" value="Reservada")
        label(for="dni_foto") Subí tu foto del DNI (máx. 10MB):
        input(type="file" name="dni_foto" id="dni_foto" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" required)
        button(type="submit") Crear Turno
    include ../includes/footer
    script(src="/js/logout.js")
    script(src="/js/horarios.js")
    script(src="https://cdn.jsdelivr.net/npm/flatpickr")
    script(src="/js/alerta.js")
    script.
      
      document.getElementById('dni_foto').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          
          const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
          if (!allowedTypes.includes(file.type)) {
            this.setCustomValidity('Solo se aceptan imágenes (JPEG, PNG, GIF, WEBP)');
            this.reportValidity();
            this.value = ''; 
            return;
          }
          
          
          const maxSize = 10 * 1024 * 1024; 
          if (file.size > maxSize) {
            this.setCustomValidity('El archivo es demasiado grande. El tamaño máximo es 10MB');
            this.reportValidity();
            this.value = ''; 
            return;
          }
          
          
          this.setCustomValidity('');
        }
      });
      
      // Función para cargar profesionales según sucursal y especialidad
      async function cargarProfesionales() {
        const sucursalSelect = document.getElementById('sucursal-filtro');
        const especialidadSelect = document.getElementById('especialidad-filtro');
        const profesionalSelect = document.getElementById('profesional-select');
        
        const sucursalId = sucursalSelect.value;
        const especialidadId = especialidadSelect.value;
        
        // Limpiar select de profesionales
        profesionalSelect.innerHTML = '<option value="" selected disabled>Selecciona un profesional</option>';
        
        // Si no hay ambos filtros seleccionados, deshabilitar
        if (!sucursalId || !especialidadId) {
          profesionalSelect.disabled = true;
          profesionalSelect.innerHTML = '<option value="" selected disabled>Primero seleccioná sucursal y especialidad</option>';
          return;
        }
        
        try {
          // Cargar profesionales filtrados
          const response = await fetch(`/profesional/buscar?sucursalId=${sucursalId}&especialidadId=${especialidadId}`, {
            credentials: 'include'
          });
          
          if (!response.ok) {
            console.error('Error al cargar profesionales:', response.status);
            return;
          }
          
          const profesionales = await response.json();
          
          if (profesionales.length === 0) {
            profesionalSelect.innerHTML = '<option value="" selected disabled>No hay profesionales disponibles</option>';
            profesionalSelect.disabled = true;
          } else {
            profesionalSelect.disabled = false;
            profesionales.forEach(profesional => {
              const option = document.createElement('option');
              option.value = profesional.id;
              option.textContent = `${profesional.nombre_completo} - Mat: ${profesional.matricula}`;
              profesionalSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Error al cargar profesionales:', error);
          profesionalSelect.disabled = true;
        }
      }
      
      // Agregar listeners para cargar profesionales cuando cambien los filtros
      document.getElementById('sucursal-filtro').addEventListener('change', function() {
        cargarProfesionales();
        // Actualizar el input hidden con la sucursal seleccionada
        document.getElementById('sucursal-id-hidden').value = this.value;
      });
      document.getElementById('especialidad-filtro').addEventListener('change', cargarProfesionales);
      
      // Cargar sucursales y especialidades
      async function cargarFiltros() {
        try {
          // Cargar sucursales
          const responseSucursales = await fetch('/turnos/sucursales', {
            credentials: 'include'
          });
          
          if (!responseSucursales.ok) {
            console.error('Error al cargar sucursales:', responseSucursales.status);
            return;
          }
          
          const sucursales = await responseSucursales.json();
          const sucursalSelect = document.getElementById('sucursal-filtro');
          
          sucursales.forEach(sucursal => {
            const option = document.createElement('option');
            option.value = sucursal.id;
            option.textContent = sucursal.nombre;
            sucursalSelect.appendChild(option);
          });
          
          // Cargar especialidades
          const responseEspecialidades = await fetch('/profesional/especialidades', {
            credentials: 'include'
          });
          
          if (!responseEspecialidades.ok) {
            console.error('Error al cargar especialidades:', responseEspecialidades.status);
            return;
          }
          
          const especialidades = await responseEspecialidades.json();
          const especialidadSelect = document.getElementById('especialidad-filtro');
          
          especialidades.forEach(especialidad => {
            const option = document.createElement('option');
            option.value = especialidad.id;
            option.textContent = especialidad.nombre;
            especialidadSelect.appendChild(option);
          });
          
          console.log('Filtros cargados correctamente');
        } catch (error) {
          console.error('Error al cargar filtros:', error);
        }
      }
      
      cargarFiltros();